# 바스켓 이동 로직 개선 및 시나리오 3 구현 계획

## 1. 개요

현재 `basket_movement.py`의 로직을 확장하여 아래 두 가지 핵심 기능을 추가합니다. 
이 문서는 해당 기능 구현을 위한 단계별 계획을 정의합니다.

- **기능 1: 구간별 속도 제어 시스템**
  - 특정 레인 구간(Zone)의 속도가 동적으로 변화 (가속/감속)
  - 속도 변화는 주기적으로 랜덤하게 발생
  - 프론트엔드에서 시각적으로 확인 가능해야 함

- **기능 2: 바스켓 병목 현상 시뮬레이션 및 제어**
  - 바스켓이 앞선 바스켓을 따라잡아 간격이 좁혀지면, 선두 바스켓을 제외한 후행 바스켓들은 일시 정지
  - 선두 바스켓이 이동하여 안전거리(약 1개 구간)가 확보되면, 후행 바스켓들이 순차적으로 하나씩 출발
  - 정지된 바스켓은 '병목 상태'로 식별되어야 함

## 2. 예상되는 수정 범위

- **`sensor_simulator/basket_movement.py`**: 핵심 로직 수정. 바스켓의 상태 관리, 속도 계산, 충돌 감지 및 이동 재개 로직이 추가됩니다.
- **`backend/models.py`**: 바스켓과 존(Zone)의 상태(속도 계수, 병목 상태 등)를 저장할 새로운 데이터 필드를 추가합니다.
- **`backend/backend_main.py`**: 시뮬레이터의 상태를 프론트엔드로 전달하는 API(/simulator/status)의 응답 데이터 구조를 확장합니다.
- **`frontend/src/BasketVisualizationPage.jsx`**: API로부터 받은 새로운 상태 정보를 기반으로, 구간별 속도 변화와 바스켓의 병목 상태를 시각적으로 렌더링하는 로직을 추가합니다.

## 3. 단계별 구현 계획

### 1단계: 데이터 구조 확장

- **목표**: 구간별 속도 계수와 바스켓의 병목 상태를 저장할 데이터 모델을 수정합니다.
- **작업 내용**:
    1. **`Zone` 정보에 `speed_modifier` 속성 추가**:
        - 각 존(Zone) 객체 또는 데이터에 속도 계수(`speed_modifier`) 필드를 추가합니다. (기본값: 1.0)
        - 예: `1.5` (1.5배 가속), `0.5` (0.5배 감속)
    2. **`Basket` 정보에 `status` 및 `is_bottleneck` 속성 추가**:
        - 바스켓 객체에 현재 상태를 나타내는 `status` 필드를 추가합니다. (예: 'moving', 'stopped')
        - 병목 현상에 걸렸는지 여부를 나타내는 `is_bottleneck` 불리언 필드를 추가합니다.

### 2단계: 구간별 속도 제어 로직 구현

- **목표**: `BasketMovement` 시뮬레이터가 `Zone`의 `speed_modifier`를 읽어 바스켓 이동 속도에 반영하도록 수정합니다.
- **작업 내용**:
    1. **`Zone` 속도 관리자(ZoneSpeedManager) 클래스 구현**:
        - 주기적으로 (예: 매 10초마다) 랜덤한 `Zone` 몇 개를 선택합니다.
        - 선택된 `Zone`들의 `speed_modifier` 값을 랜덤하게 변경하는 로직을 작성합니다. (예: 0.5, 1.0, 1.5 중 하나)
    2. **`BasketMovement` 속도 계산 로직 수정**:
        - `_move_basket`과 같은 바스켓 위치 업데이트 함수 내부에서, 해당 바스켓이 위치한 `Zone`의 `speed_modifier` 값을 가져옵니다.
        - 최종 이동 속도를 `base_speed * speed_modifier`로 계산하도록 수정합니다.

### 3단계: 병목 현상 감지 및 일시 정지 로직 구현

- **목표**: 바스켓 간의 거리를 계산하여 충돌을 방지하고, 후행 바스켓을 '병목 상태'로 전환합니다.
- **작업 내용**:
    1. **`BasketMovement`의 메인 루프 수정**:
        - 각 바스켓을 이동시키기 전, 같은 라인에 있는 바로 앞 바스켓과의 거리를 계산하는 함수를 추가합니다.
    2. **충돌 감지 및 상태 변경 로직 추가**:
        - 만약 앞 바스켓과의 거리가 설정된 안전거리(예: 1개 Zone의 길이)보다 짧으면,
        - 현재 바스켓의 `status`를 'stopped'로, `is_bottleneck`을 `True`로 변경합니다.
        - `status`가 'stopped'인 바스켓은 위치 업데이트 로직을 건너뛰어 이동을 멈춥니다.

### 4단계: 병목 해소 및 순차적 이동 재개 로직 구현

- **목표**: 선두 바스켓이 멀어지면, 정지했던 후행 바스켓들이 순서를 지켜 하나씩 출발하도록 구현합니다.
- **작업 내용**:
    1. **`BasketMovement`의 메인 루프에 이동 재개 로직 추가**:
        - `status`가 'stopped'인 바스켓들을 대상으로, 다시 앞 바스켓과의 거리를 확인합니다.
    2. **순차적 출발 로직 구현**:
        - 만약 앞 바스켓과의 거리가 안전거리 이상으로 확보되면,
        - 해당 바스켓의 `status`를 'moving'으로, `is_bottleneck`을 `False`로 변경하여 다음 턴부터 이동을 재개합니다.
        - **(중요)** 하나의 정체된 그룹 내에서는, 가장 앞에 있던 바스켓부터 이동을 재개해야 합니다. 즉, 한 번의 루프에서 각 병목 그룹당 하나의 바스켓만 출발시켜 순차적 이동을 보장합니다.

### 5단계: API 및 프론트엔드 연동

- **목표**: 백엔드 API를 통해 새로운 상태 정보(구간 속도, 병목 상태)를 전달하고, 프론트엔드에서 이를 시각화합니다.
- **작업 내용**:
    1. **`/simulator/status` API 응답 데이터 확장**:
        - 전체 `Zone` 정보에 `speed_modifier`를 포함시킵니다.
        - 전체 `Basket` 정보에 `status`, `is_bottleneck`을 포함시킵니다.
    2. **`BasketVisualizationPage.jsx` 시각화 로직 수정**:
        - `speed_modifier` 값에 따라 `Zone`의 색상이나 스타일에 변화를 줍니다. (예: 파란색-가속, 주황색-감속)
        - `is_bottleneck`이 `True`인 바스켓에 특별한 시각적 효과(예: 빨간색 테두리, 아이콘 표시)를 적용합니다.
