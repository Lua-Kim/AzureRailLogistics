# 물류 레일 시스템 고도화 리팩토링 계획

## 1. 개요

본 문서는 기존 물류 레일 시뮬레이션 시스템에 다음과 같은 동적인 기능들을 추가하기 위한 리팩토링 계획을 정의합니다.

- **구간별 속도 변화:** 레일의 특정 구간에서 바스켓의 이동 속도가 주기적으로 변경됩니다.
- **병목 현상 시뮬레이션:** 바스켓이 다른 바스켓을 따라잡을 경우, 안전거리를 유지하기 위해 일시적으로 정지하고 순차적으로 다시 출발합니다.
- **시각화 연동:** 위의 모든 변경 사항을 프론트엔드에서 실시간으로 확인할 수 있도록 시각적 요소를 추가합니다.

---

## 2. 요구사항 상세

1.  **구간별 속도 제어**
    -   각 레일(Line)은 여러 개의 속도 제어 구간(Speed Zone)을 가질 수 있습니다.
    -   각 구간은 `시작 위치`, `끝 위치`, `속도 계수(multiplier)` 속성을 가집니다.
    -   이 구간들의 속성은 시스템 운영 중 주기적으로, 그리고 랜덤하게 변경되어야 합니다.
    -   바스켓은 해당 구간을 지날 때 기본 속도에 속도 계수를 곱한 속도로 이동합니다.

2.  **병목 현상 처리 (충돌 방지)**
    -   바스켓이 이동 중 앞서가는 바스켓과의 거리가 특정 임계값(예: 바스켓 하나의 크기) 이하로 가까워지면, 뒤따라오던 바스켓은 즉시 정지합니다.
    -   정지한 바스켓은 '병목 상태'로 판정됩니다.
    -   앞선 바스켓이 다시 일정 거리 이상 멀어지면, 정지했던 바스켓들이 순차적으로(앞에 있던 바스켓부터) 이동을 재개합니다.

3.  **프론트엔드 시각화**
    -   레일 위에 설정된 `속도 제어 구간`이 시각적으로 구분되어 표시되어야 합니다. (예: 가속 구간 - 녹색, 감속 구간 - 노란색)
    -   '병목 상태'에 빠진 바스켓은 다른 색상(예: 빨간색)으로 표시되어야 합니다.

---

## 3. 단계별 실행 계획

### 1단계: 모델 및 DB 스키마 확장

-   **목표:** 구간별 속도 데이터를 저장할 수 있도록 데이터베이스 모델을 확장합니다.
-   **작업 내용:**
    1.  `backend/models.py`의 `Line` 모델에 `line_details` (JSON 타입) 필드를 추가합니다. 이 필드는 `{"speed_multipliers": [{"start": 0.2, "end": 0.5, "multiplier": 1.5}, ...]}`와 같은 구조를 가집니다.
    2.  `Data_schema/logistics_line_schema.json` 파일에도 해당 `line_details` 속성 정의를 추가하여 데이터 스키마의 일관성을 유지합니다.
    3.  (필요시) 데이터베이스 마이그레이션을 수행하여 실제 DB 테이블에 컬럼을 추가합니다.

### 2단계: 구간 속도 관리 로직 추가

-   **목표:** 주기적으로 각 레인의 구간별 속도 설정을 랜덤하게 변경하는 백그라운드 로직을 구현합니다.
-   **작업 내용:**
    1.  `backend/backend_main.py`에 백그라운드 스케줄러(예: `APScheduler`)를 설정합니다.
    2.  일정 주기(예: 1분)마다 모든 `Line` 객체를 조회하여 `line_details` 필드의 `speed_multipliers` 값을 랜덤하게 생성하고 업데이트하는 함수를 구현하고 스케줄러에 등록합니다.

### 3단계: 물리 엔진 고도화 (BasketMovement)

-   **목표:** `BasketMovement` 시뮬레이터가 `line_details`를 참조하여 바스켓의 속도를 동적으로 조절하도록 수정합니다.
-   **작업 내용:**
    1.  `sensor_simulator/basket_movement.py`의 `BasketMovement` 클래스를 수정합니다.
    2.  `update_position` 메소드에서, 바스켓의 현재 위치가 속한 레인의 `line_details` 정보를 DB에서 가져옵니다.
    3.  바스켓이 특수 속도 구간 내에 있는지 확인하고, 해당된다면 속도 계수(multiplier)를 기본 속도에 적용합니다.

### 4단계: 병목 현상 감지 및 처리 로직 추가

-   **목표:** 바스켓 간의 충돌을 방지하고 병목 현상을 시뮬레이션하는 로직을 `BasketMovement`에 추가합니다.
-   **작업 내용:**
    1.  `sensor_simulator/basket_movement.py`의 `update_position` 메소드를 수정합니다.
    2.  각 바스켓을 업데이트하기 전에, 같은 레일 위에 있는 다른 바스켓들의 위치를 모두 확인합니다.
    3.  자신의 이동 방향 바로 앞에 일정 거리 내에 다른 바스켓이 있는지 검사합니다.
    4.  앞에 바스켓이 있다면, 현재 바스켓의 속도를 0으로 만들고 `is_bottlenecked` 상태를 `True`로 설정합니다.
    5.  앞선 바스켓이 멀어져 공간이 생기면, `is_bottlenecked`를 `False`로 바꾸고 이동을 재개합니다. 이 때, 여러 바스켓이 멈춰있었다면 가장 앞에 있던 바스켓부터 순차적으로 출발하도록 제어합니다.

### 5단계: 프론트엔드 시각화 업데이트

-   **목표:** 백엔드의 새로운 데이터(`line_details`, `is_bottlenecked`)를 프론트엔드에 반영하여 사용자에게 시각적으로 보여줍니다.
-   **작업 내용:**
    1.  `frontend/src/api.js`: 라인 및 바스켓 데이터를 가져오는 API 호출 로직을 수정하여 `line_details`와 `is_bottlenecked` 정보를 함께 받아오도록 합니다.
    2.  `frontend/src/BasketVisualizationPage.jsx`:
        -   `line_details` 정보를 기반으로 레일 위에 속도 제어 구간을 각기 다른 색상이나 스타일로 렌더링합니다.
        -   바스켓의 `is_bottlenecked` 상태가 `True`일 경우, 해당 바스켓의 색상을 변경하거나 특별한 아이콘을 표시하여 병목 상태임을 시각적으로 나타냅니다.
